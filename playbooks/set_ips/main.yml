---
- name: Host Variables
  hosts: all
  gather_facts: yes
  sudo: yes

  tasks:
    - name: Ensure primary_controller_host is set.
      local_action: >
          lineinfile
          dest=../../group_vars/all
          regexp="^primary_controller_host:"
          line="primary_controller_host: {{ groups['controller'][0] }}"
      when: "primary_controller_host is not defined"

    - name: Ensure primary_frontend_host is set.
      local_action: >
          lineinfile
          dest=../../group_vars/all
          regexp="^primary_frontend_host:"
          line="primary_frontend_host: {{ groups['frontend'][0] }}"
      when: "primary_frontend_host is not defined"

    - name: ensure my_int_ip is a fact variable
      action: set_fact
      args:
        my_int_ip: "{{ my_int_ip }}"
  
    - name: ensure my_ext_ip is a fact variable
      action: set_fact
      args:
        my_ext_ip: "{{ my_ext_ip }}"
  
    - name: ensure my_ext_ip is a fact variable (br-ex)
      action: set_fact
      args:
        my_ext_ip: "{{ ansible_br_ex['ipv4']['address'] }}"
      when: "ansible_br_ex is defined"
  
    - name: Ensure controller_ip is set.
      local_action: >
          lineinfile
          dest=../../group_vars/all
          regexp="^controller_ip:"
          line="controller_ip: {{ hostvars[first_host['controller']]['my_int_ip'] }}"
      when: "controller_ip is not defined"

    - name: Ensure frontend_int_ip is set.
      local_action: >
          lineinfile
          dest=../../group_vars/all
          regexp="^frontend_int_ip:"
          line="frontend_int_ip: {{ hostvars[first_host['frontend']]['my_int_ip'] }}"
      when: "frontend_int_ip is not defined"

    - name: Ensure frontend_ext_ip is set.
      local_action: >
          lineinfile
          dest=../../group_vars/all
          regexp="^frontend_ext_ip:"
          line="frontend_ext_ip: {{ hostvars[first_host['frontend']]['my_ext_ip'] }}"
      when: "frontend_ext_ip is not defined"

    - name: gather the last facts
      action: setup

    - name: display frontend_ext_ip, frontend_int_ip and controller_ip.
      command: echo ${frontend_ext_ip} ${frontend_int_ip} ${controller_ip}
